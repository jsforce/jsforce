!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;(t=(t=(t=(t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).jsforce||(t.jsforce={})).modules||(t.modules={})).api||(t.api={})).Bulk=e()}}((function(){return function e(t,n,r){function o(s,a){if(!n[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(i)return i(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var h=n[s]={exports:{}};t[s][0].call(h.exports,(function(e){return o(t[s][1][e]||e)}),h,h.exports,e,t,n,r)}return n[s].exports}for(var i="function"==typeof require&&require,s=0;s<r.length;s++)o(r[s]);return o}({1:[function(e,t,n){(function(e){"use strict";var n=window.jsforce.require("inherits"),r=window.jsforce.require("readable-stream"),o=r.Duplex,i=window.jsforce.require("events"),s=window.jsforce.require("lodash/core"),a=window.jsforce.require("multistream"),u=window.jsforce.require("./core"),c=window.jsforce.require("./record-stream"),h=window.jsforce.require("./promise"),l=window.jsforce.require("./http-api"),f=function(e,t,n,r,o){this._bulk=e,this.type=t,this.operation=n,this.options=r||{},this.id=o,this.state=this.id?"Open":"Unknown",this._batches={}};n(f,i.EventEmitter),f.prototype.info=function(e){var t=this;if(this._jobInfo){if(t.options.pkChunking)return this._jobInfo.then(n=>("0"!==n.numberBatchesTotal&&n.numberBatchesTotal===n.numberBatchesCompleted?t._jobInfo=h.resolve(n):t._jobInfo=t.check(),t._jobInfo.thenCall(e)))}else this._jobInfo=this.check();return this._jobInfo.thenCall(e)},f.prototype.open=function(e){var t=this,n=this._bulk;n._logger;if(!this._jobInfo){var r=this.operation.toLowerCase();"harddelete"===r&&(r="hardDelete");var o=['<?xml version="1.0" encoding="UTF-8"?>','<jobInfo  xmlns="http://www.force.com/2009/06/asyncapi/dataload">',"<operation>"+r+"</operation>","<object>"+this.type+"</object>",this.options.extIdField?"<externalIdFieldName>"+this.options.extIdField+"</externalIdFieldName>":"",this.options.concurrencyMode?"<concurrencyMode>"+this.options.concurrencyMode+"</concurrencyMode>":"",this.options.assignmentRuleId?"<assignmentRuleId>"+this.options.assignmentRuleId+"</assignmentRuleId>":"","<contentType>CSV</contentType>","</jobInfo>"].join(""),i={"Content-Type":"application/xml; charset=utf-8"},s=this.options.pkChunking;if(s){var a=Object.keys(s).filter((function(e){return["chunkSize","parent","startRow"].indexOf(e)>=0})).map((function(e){return e+"="+s[e]}));a.length&&(i["Sforce-Enable-PKChunking"]=a.join("; "))}this._jobInfo=n._request({method:"POST",path:"/job",body:o,headers:i,responseType:"application/xml"}).then((function(e){return t.emit("open",e.jobInfo),t.id=e.jobInfo.id,t.state=e.jobInfo.state,e.jobInfo}),(function(e){throw t.emit("error",e),e}))}return this._jobInfo.thenCall(e)},f.prototype.createBatch=function(){var e=new p(this),t=this;return e.on("queue",(function(){t._batches[e.id]=e})),e},f.prototype.batch=function(e){var t=this._batches[e];return t||(t=new p(this,e),this._batches[e]=t),t},f.prototype.check=function(e){var t=this,n=this._bulk,r=n._logger;return this._jobInfo=this._waitAssign().then((function(){return n._request({method:"GET",path:"/job/"+t.id,responseType:"application/xml"})})).then((function(e){return r.debug(e.jobInfo),t.id=e.jobInfo.id,t.type=e.jobInfo.object,t.operation=e.jobInfo.operation,t.state=e.jobInfo.state,e.jobInfo})),this._jobInfo.thenCall(e)},f.prototype._waitAssign=function(e){return(this.id?h.resolve({id:this.id}):this.open()).thenCall(e)},f.prototype.list=function(e){var t=this,n=this._bulk,r=n._logger;return this._waitAssign().then((function(){return n._request({method:"GET",path:"/job/"+t.id+"/batch",responseType:"application/xml"})})).then((function(e){r.debug(e.batchInfoList.batchInfo);var t=e.batchInfoList;return t=s.isArray(t.batchInfo)?t.batchInfo:[t.batchInfo]})).thenCall(e)},f.prototype.retrieveBatches=function(e){var t=this;return t.list().then(e=>h.all(e.map((function(e){if("NotProcessed"===e.state||0===parseInt(e.numberRecordsProcessed,10))return h.resolve();if("Failed"===e.state&&0===parseInt(e.numberRecordsProcessed,10))throw new Error(e.stateMessage);return t.batch(e.id).retrieve()})))).then((function(e){const t=[];return e.forEach((function(e){e&&t.push(...e)})),t})).then((function(e){return t.close().then((function(){return e}))})).fail((function(e){return t.emit("error",e),t.abort().then(()=>{throw e})})).thenCall(e)},f.prototype.close=function(){var e=this;return this._changeState("Closed").then((function(t){return e.id=null,e.emit("close",t),t}),(function(t){throw e.emit("error",t),t}))},f.prototype.abort=function(){var e=this;return this._changeState("Aborted").then((function(t){return e.id=null,e.emit("abort",t),t}),(function(t){throw e.emit("error",t),t}))},f.prototype._changeState=function(e,t){var n=this,r=this._bulk,o=r._logger;return this._jobInfo=this._waitAssign().then((function(){var t=['<?xml version="1.0" encoding="UTF-8"?>','<jobInfo xmlns="http://www.force.com/2009/06/asyncapi/dataload">',"<state>"+e+"</state>","</jobInfo>"].join("");return r._request({method:"POST",path:"/job/"+n.id,body:t,headers:{"Content-Type":"application/xml; charset=utf-8"},responseType:"application/xml"})})).then((function(e){return o.debug(e.jobInfo),n.state=e.jobInfo.state,e.jobInfo})),this._jobInfo.thenCall(t)};var p=function(e,t){p.super_.call(this,{objectMode:!0}),this.job=e,this.id=t,this._bulk=e._bulk,this._deferred=h.defer(),this._setupDataStreams()};n(p,r.Writable),p.prototype._setupDataStreams=function(){var e=this,t={nullValue:"#N/A"};this._uploadStream=new c.Serializable,this._uploadDataStream=this._uploadStream.stream("csv",t),this._downloadStream=new c.Parsable,this._downloadDataStream=this._downloadStream.stream("csv",t),this.on("finish",(function(){e._uploadStream.end()})),this._uploadDataStream.once("readable",(function(){e.job.open().then((function(){e._uploadDataStream.pipe(e._createRequestStream())}))}));var n=this._dataStream=new o;n._write=function(t,n,r){e._uploadDataStream.write(t,n,r)},n.on("finish",(function(){e._uploadDataStream.end()})),this._downloadDataStream.on("readable",(function(){n.read(0)})),this._downloadDataStream.on("end",(function(){n.push(null)})),n._read=function(t){for(var r;null!==(r=e._downloadDataStream.read());)n.push(r)}},p.prototype._createRequestStream=function(){var e=this,t=e._bulk,n=t._logger;return t._request({method:"POST",path:"/job/"+e.job.id+"/batch",headers:{"Content-Type":"text/csv"},responseType:"application/xml"},(function(t,r){t?e.emit("error",t):(n.debug(r.batchInfo),e.id=r.batchInfo.id,e.emit("queue",r.batchInfo))})).stream()},p.prototype._write=function(e,t,n){e=s.clone(e),"insert"===this.job.operation?delete e.Id:"delete"===this.job.operation&&(e={Id:e.Id}),delete e.type,delete e.attributes,this._uploadStream.write(e,t,n)},p.prototype.stream=function(){return this._dataStream},p.prototype.run=p.prototype.exec=p.prototype.execute=function(e,t){var n=this;if("function"==typeof e&&(t=e,e=null),this._result)throw new Error("Batch already executed.");var r,o=h.defer();(this._result=o.promise,this._result.then((function(e){n._deferred.resolve(e)}),(function(e){n._deferred.reject(e)})),this.once("response",(function(e){o.resolve(e)})),this.once("error",(function(e){o.reject(e)})),s.isObject(e)&&s.isFunction(e.pipe))?e.pipe(this._dataStream):s.isArray(e)?(s.forEach(e,(function(e){Object.keys(e).forEach((function(t){"boolean"==typeof e[t]&&(e[t]=String(e[t]))})),n.write(e)})),n.end()):s.isString(e)&&(r=e,this._dataStream.write(r,"utf8"),this._dataStream.end());return this.thenCall(t)},p.prototype.then=function(e,t,n){return this._deferred.promise.then(e,t,n)},p.prototype.thenCall=function(t){return s.isFunction(t)&&this.then((function(n){e.nextTick((function(){t(null,n)}))}),(function(n){e.nextTick((function(){t(n)}))})),this},p.prototype.check=function(e){var t=this._bulk,n=t._logger,r=this.job.id,o=this.id;if(!r||!o)throw new Error("Batch not started.");return t._request({method:"GET",path:"/job/"+r+"/batch/"+o,responseType:"application/xml"}).then((function(e){return n.debug(e.batchInfo),e.batchInfo})).thenCall(e)},p.prototype.poll=function(e,t){var n=this,r=this.job,o=this.id;if(!r.id||!o)throw new Error("Batch not started.");var i=(new Date).getTime(),s=function(){var a=(new Date).getTime();if(i+t<a){var u=new Error("Polling time out. Job Id = "+r.id+" , batch Id = "+o);return u.name="PollingTimeout",u.jobId=r.id,u.batchId=o,void n.emit("error",u)}r.info().then((function(t){n.check((function(o,i){const a="0"!==t.numberBatchesTotal&&t.numberBatchesTotal===t.numberBatchesCompleted;o?n.emit("error",o):"Failed"===i.state?parseInt(i.numberRecordsProcessed,10)>0?n.retrieve():n.emit("error",new Error(i.stateMessage)):"Completed"===i.state?n.retrieve():"NotProcessed"===i.state&&a?r.retrieveBatches().then(e=>{n.emit("response",e)}).fail((function(e){n.emit("error",e)})):(n.emit("progress",i),setTimeout(s,e))}))}))};setTimeout(s,e)},p.prototype.retrieve=function(e){var t=this,n=this._bulk,r=this.job.id,o=this.job,i=this.id;if(!r||!i)throw new Error("Batch not started.");return o.info().then((function(e){return n._request({method:"GET",path:"/job/"+r+"/batch/"+i+"/result"})})).then((function(e){var a;if("query"===o.operation){n._conn,e["result-list"].result;a=e["result-list"].result,a=s.map(s.isArray(a)?a:[a],(function(e){return{id:e,batchId:i,jobId:r}}))}else a=s.map(e,(function(e){return{id:e.Id||null,success:"true"===e.Success,errors:e.Error?[e.Error]:[]}}));return t.emit("response",a),a})).fail((function(e){throw t.emit("error",e),e})).thenCall(e)},p.prototype.result=function(e){var t=this.job.id,n=this.id;if(!t||!n)throw new Error("Batch not started.");var r=new c.Parsable,o=r.stream("csv");this._bulk._request({method:"GET",path:"/job/"+t+"/batch/"+n+"/result/"+e,responseType:"application/octet-stream",forever:!0,gzip:!0}).stream().on("error",e=>o.emit("error",e)).pipe(o);return r};var d=function(){d.super_.apply(this,arguments)};n(d,l),d.prototype.beforeSend=function(e){e.headers=e.headers||{},e.headers["X-SFDC-SESSION"]=this._conn.accessToken},d.prototype.isSessionExpired=function(e){return 400===e.statusCode&&/<exceptionCode>InvalidSessionId<\/exceptionCode>/.test(e.body)},d.prototype.hasErrorInResponseBody=function(e){return!!e.error},d.prototype.parseError=function(e){return{errorCode:e.error.exceptionCode,message:e.error.exceptionMessage}};var b=function(e){this._conn=e,this._logger=e._logger};b.prototype.pollInterval=1e3,b.prototype.pollTimeout=1e4,b.prototype._request=function(e,t){var n=this._conn;e=s.clone(e);var r=[n.instanceUrl,"services/async",n.version].join("/");e.url=r+e.path;var o={responseType:e.responseType};return delete e.path,delete e.responseType,new d(this._conn,o).on("requestDuration",e=>n.emit("requestDuration",e)).request(e).thenCall(t)},b.prototype.load=function(e,t,n,r,o){var i=this;if(!e||!t)throw new Error("Insufficient arguments. At least, 'type' and 'operation' are required.");s.isObject(n)&&n.constructor===Object||(o=r,r=n,n=null);var a=this.createJob(e,t,n);a.once("error",(function(e){u&&u.emit("error",e)}));var u=a.createBatch(),c=function(){u=null,a.close()};return u.on("response",c),u.on("error",(function(e){"PollingTimeout"!==e.name&&c()})),u.on("queue",(function(){u.poll(i.pollInterval,i.pollTimeout)})),u.execute(r,o)},b.prototype.query=function(e,t){var n=e.replace(/\([\s\S]+\)/g,"").match(/FROM\s+(\w+)/i);if(!n)throw new Error("No sobject type found in query, maybe caused by invalid SOQL.");var r=n[1],o=this,i=new c.Parsable,s=i.stream("csv");return this.load(r,"query",t||{},e).then((function(e){var t=e.map((function(e){const t=o.job(e.jobId).batch(e.batchId);return function(){return t.result(e.id).stream()}}));a(t).on("error",e=>s.emit("error",e)).on("end",()=>s.emit("end")).pipe(s)})).fail((function(e){s.emit("error",e)})),i},b.prototype.createJob=function(e,t,n){return new f(this,e,t,n)},b.prototype.job=function(e){return new f(this,null,null,null,e)},u.on("connection:new",(function(e){e.bulk=new b(e)})),t.exports=b}).call(this,e("_process"))},{_process:2}],2:[function(e,t,n){var r,o,i=t.exports={};function s(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function u(e){if(r===setTimeout)return setTimeout(e,0);if((r===s||!r)&&setTimeout)return r=setTimeout,setTimeout(e,0);try{return r(e,0)}catch(t){try{return r.call(null,e,0)}catch(t){return r.call(this,e,0)}}}!function(){try{r="function"==typeof setTimeout?setTimeout:s}catch(e){r=s}try{o="function"==typeof clearTimeout?clearTimeout:a}catch(e){o=a}}();var c,h=[],l=!1,f=-1;function p(){l&&c&&(l=!1,c.length?h=c.concat(h):f=-1,h.length&&d())}function d(){if(!l){var e=u(p);l=!0;for(var t=h.length;t;){for(c=h,h=[];++f<t;)c&&c[f].run();f=-1,t=h.length}c=null,l=!1,function(e){if(o===clearTimeout)return clearTimeout(e);if((o===a||!o)&&clearTimeout)return o=clearTimeout,clearTimeout(e);try{o(e)}catch(t){try{return o.call(null,e)}catch(t){return o.call(this,e)}}}(e)}}function b(e,t){this.fun=e,this.array=t}function m(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];h.push(new b(e,t)),1!==h.length||l||u(d)},b.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=m,i.addListener=m,i.once=m,i.off=m,i.removeListener=m,i.removeAllListeners=m,i.emit=m,i.prependListener=m,i.prependOnceListener=m,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},{}]},{},[1])(1)}));
//# sourceMappingURL=jsforce-api-bulk.min.js.map
