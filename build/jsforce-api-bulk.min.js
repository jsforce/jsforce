!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t=t.jsforce||(t.jsforce={}),t=t.modules||(t.modules={}),t=t.api||(t.api={}),t.Bulk=e()}}(function(){return function e(t,o,n){function r(s,a){if(!o[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(i)return i(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var h=o[s]={exports:{}};t[s][0].call(h.exports,function(e){var o=t[s][1][e];return r(o?o:e)},h,h.exports,e,t,o,n)}return o[s].exports}for(var i="function"==typeof require&&require,s=0;s<n.length;s++)r(n[s]);return r}({1:[function(e,t,o){(function(e){"use strict";var o=window.jsforce.require("inherits"),n=window.jsforce.require("readable-stream"),r=n.Duplex,i=window.jsforce.require("events"),s=window.jsforce.require("lodash/core"),a=window.jsforce.require("./core"),u=window.jsforce.require("./record-stream"),c=(window.jsforce.require("./csv"),window.jsforce.require("./promise")),h=window.jsforce.require("./http-api"),p=function(e,t,o,n,r){this._bulk=e,this.type=t,this.operation=o,this.options=n||{},this.id=r,this.state=this.id?"Open":"Unknown",this._batches={}};o(p,i.EventEmitter),p.prototype.info=function(e){return this._jobInfo||(this._jobInfo=this.check()),this._jobInfo.thenCall(e)},p.prototype.open=function(e){var t=this,o=this._bulk;o._logger;if(!this._jobInfo){var n=this.operation.toLowerCase();"harddelete"===n&&(n="hardDelete");var r=['<?xml version="1.0" encoding="UTF-8"?>','<jobInfo  xmlns="http://www.force.com/2009/06/asyncapi/dataload">',"<operation>"+n+"</operation>","<object>"+this.type+"</object>",this.options.extIdField?"<externalIdFieldName>"+this.options.extIdField+"</externalIdFieldName>":"",this.options.concurrencyMode?"<concurrencyMode>"+this.options.concurrencyMode+"</concurrencyMode>":"",this.options.assignmentRuleId?"<assignmentRuleId>"+this.options.assignmentRuleId+"</assignmentRuleId>":"","<contentType>CSV</contentType>","</jobInfo>"].join("");this._jobInfo=o._request({method:"POST",path:"/job",body:r,headers:{"Content-Type":"application/xml; charset=utf-8"},responseType:"application/xml"}).then(function(e){return t.emit("open",e.jobInfo),t.id=e.jobInfo.id,t.state=e.jobInfo.state,e.jobInfo},function(e){throw t.emit("error",e),e})}return this._jobInfo.thenCall(e)},p.prototype.createBatch=function(){var e=new l(this),t=this;return e.on("queue",function(){t._batches[e.id]=e}),e},p.prototype.batch=function(e){var t=this._batches[e];return t||(t=new l(this,e),this._batches[e]=t),t},p.prototype.check=function(e){var t=this,o=this._bulk,n=o._logger;return this._jobInfo=this._waitAssign().then(function(){return o._request({method:"GET",path:"/job/"+t.id,responseType:"application/xml"})}).then(function(e){return n.debug(e.jobInfo),t.id=e.jobInfo.id,t.type=e.jobInfo.object,t.operation=e.jobInfo.operation,t.state=e.jobInfo.state,e.jobInfo}),this._jobInfo.thenCall(e)},p.prototype._waitAssign=function(e){return(this.id?c.resolve({id:this.id}):this.open()).thenCall(e)},p.prototype.list=function(e){var t=this,o=this._bulk,n=o._logger;return this._waitAssign().then(function(){return o._request({method:"GET",path:"/job/"+t.id+"/batch",responseType:"application/xml"})}).then(function(e){n.debug(e.batchInfoList.batchInfo);var t=e.batchInfoList;return t=s.isArray(t.batchInfo)?t.batchInfo:[t.batchInfo]}).thenCall(e)},p.prototype.close=function(){var e=this;return this._changeState("Closed").then(function(t){return e.id=null,e.emit("close",t),t},function(t){throw e.emit("error",t),t})},p.prototype.abort=function(){var e=this;return this._changeState("Aborted").then(function(t){return e.id=null,e.emit("abort",t),t},function(t){throw e.emit("error",t),t})},p.prototype._changeState=function(e,t){var o=this,n=this._bulk,r=n._logger;return this._jobInfo=this._waitAssign().then(function(){var t=['<?xml version="1.0" encoding="UTF-8"?>','<jobInfo xmlns="http://www.force.com/2009/06/asyncapi/dataload">',"<state>"+e+"</state>","</jobInfo>"].join("");return n._request({method:"POST",path:"/job/"+o.id,body:t,headers:{"Content-Type":"application/xml; charset=utf-8"},responseType:"application/xml"})}).then(function(e){return r.debug(e.jobInfo),o.state=e.jobInfo.state,e.jobInfo}),this._jobInfo.thenCall(t)};var l=function(e,t){l.super_.call(this,{objectMode:!0}),this.job=e,this.id=t,this._bulk=e._bulk,this._deferred=c.defer(),this._setupDataStreams()};o(l,n.Writable),l.prototype._setupDataStreams=function(){var e=this,t={nullValue:"#N/A"};this._uploadStream=new u.Serializable,this._uploadDataStream=this._uploadStream.stream("csv",t),this._downloadStream=new u.Parsable,this._downloadDataStream=this._downloadStream.stream("csv",t),this.on("finish",function(){e._uploadStream.end()}),this._uploadDataStream.once("readable",function(){e.job.open().then(function(){e._uploadDataStream.pipe(e._createRequestStream())})});var o=this._dataStream=new r;o._write=function(t,o,n){e._uploadDataStream.write(t,o,n)},o.on("finish",function(){e._uploadDataStream.end()}),this._downloadDataStream.on("readable",function(){o.read(0)}),this._downloadDataStream.on("end",function(){o.push(null)}),o._read=function(t){for(var n;null!==(n=e._downloadDataStream.read());)o.push(n)}},l.prototype._createRequestStream=function(){var e=this,t=e._bulk,o=t._logger;return t._request({method:"POST",path:"/job/"+e.job.id+"/batch",headers:{"Content-Type":"text/csv"},responseType:"application/xml"},function(t,n){t?e.emit("error",t):(o.debug(n.batchInfo),e.id=n.batchInfo.id,e.emit("queue",n.batchInfo))}).stream()},l.prototype._write=function(e,t,o){e=s.clone(e),"insert"===this.job.operation?delete e.Id:"delete"===this.job.operation&&(e={Id:e.Id}),delete e.type,delete e.attributes,this._uploadStream.write(e,t,o)},l.prototype.stream=function(){return this._dataStream},l.prototype.run=l.prototype.exec=l.prototype.execute=function(e,t){var o=this;if("function"==typeof e&&(t=e,e=null),this._result)throw new Error("Batch already executed.");var n=c.defer();if(this._result=n.promise,this._result.then(function(e){o._deferred.resolve(e)},function(e){o._deferred.reject(e)}),this.once("response",function(e){n.resolve(e)}),this.once("error",function(e){n.reject(e)}),s.isObject(e)&&s.isFunction(e.pipe))e.pipe(this._dataStream);else{var r;s.isArray(e)?(s.forEach(e,function(e){o.write(e)}),o.end()):s.isString(e)&&(r=e,this._dataStream.write(r,"utf8"),this._dataStream.end())}return this.thenCall(t)},l.prototype.then=function(e,t,o){return this._deferred.promise.then(e,t,o)},l.prototype.thenCall=function(t){return s.isFunction(t)&&this.then(function(o){e.nextTick(function(){t(null,o)})},function(o){e.nextTick(function(){t(o)})}),this},l.prototype.check=function(e){var t=this._bulk,o=t._logger,n=this.job.id,r=this.id;if(!n||!r)throw new Error("Batch not started.");return t._request({method:"GET",path:"/job/"+n+"/batch/"+r,responseType:"application/xml"}).then(function(e){return o.debug(e.batchInfo),e.batchInfo}).thenCall(e)},l.prototype.poll=function(e,t){var o=this,n=this.job.id,r=this.id;if(!n||!r)throw new Error("Batch not started.");var i=(new Date).getTime(),s=function(){var a=(new Date).getTime();if(a>i+t){var u=new Error("Polling time out. Job Id = "+n+" , batch Id = "+r);return u.name="PollingTimeout",void o.emit("error",u)}o.check(function(t,n){t?o.emit("error",t):"Failed"===n.state?parseInt(n.numberRecordsProcessed,10)>0?o.retrieve():o.emit("error",new Error(n.stateMessage)):"Completed"===n.state?o.retrieve():(o.emit("progress",n),setTimeout(s,e))})};setTimeout(s,e)},l.prototype.retrieve=function(e){var t=this,o=this._bulk,n=this.job.id,r=this.job,i=this.id;if(!n||!i)throw new Error("Batch not started.");return r.info().then(function(e){return o._request({method:"GET",path:"/job/"+n+"/batch/"+i+"/result"})}).then(function(e){var a;if("query"===r.operation){o._conn,e["result-list"].result;a=e["result-list"].result,a=s.map(s.isArray(a)?a:[a],function(e){return{id:e,batchId:i,jobId:n}})}else a=s.map(e,function(e){return{id:e.Id||null,success:"true"===e.Success,errors:e.Error?[e.Error]:[]}});return t.emit("response",a),a}).fail(function(e){throw t.emit("error",e),e}).thenCall(e)},l.prototype.result=function(e){var t=this.job.id,o=this.id;if(!t||!o)throw new Error("Batch not started.");var n=new u.Parsable,r=n.stream("csv");this._bulk._request({method:"GET",path:"/job/"+t+"/batch/"+o+"/result/"+e}).stream().pipe(r);return n};var f=function(){f.super_.apply(this,arguments)};o(f,h),f.prototype.beforeSend=function(e){e.headers=e.headers||{},e.headers["X-SFDC-SESSION"]=this._conn.accessToken},f.prototype.isSessionExpired=function(e){return 400===e.statusCode&&/<exceptionCode>InvalidSessionId<\/exceptionCode>/.test(e.body)},f.prototype.hasErrorInResponseBody=function(e){return!!e.error},f.prototype.parseError=function(e){return{errorCode:e.error.exceptionCode,message:e.error.exceptionMessage}};var d=function(e){this._conn=e,this._logger=e._logger};d.prototype.pollInterval=1e3,d.prototype.pollTimeout=1e4,d.prototype._request=function(e,t){var o=this._conn;e=s.clone(e);var n=[o.instanceUrl,"services/async",o.version].join("/");e.url=n+e.path;var r={responseType:e.responseType};return delete e.path,delete e.responseType,new f(this._conn,r).request(e).thenCall(t)},d.prototype.load=function(e,t,o,n,r){var i=this;if(!e||!t)throw new Error("Insufficient arguments. At least, 'type' and 'operation' are required.");s.isObject(o)&&o.constructor===Object||(r=n,n=o,o=null);var a=this.createJob(e,t,o);a.once("error",function(e){u&&u.emit("error",e)});var u=a.createBatch(),c=function(){u=null,a.close()},h=function(e){"PollingTimeout"!==e.name&&c()};return u.on("response",c),u.on("error",h),u.on("queue",function(){u.poll(i.pollInterval,i.pollTimeout)}),u.execute(n,r)},d.prototype.query=function(e){var t=e.replace(/\([\s\S]+\)/g,"").match(/FROM\s+(\w+)/i);if(!t)throw new Error("No sobject type found in query, maybe caused by invalid SOQL.");var o=t[1],n=this,r=new u.Parsable,i=r.stream("csv");return this.load(o,"query",e).then(function(e){var t=e[0],o=n.job(t.jobId).batch(t.batchId).result(t.id);o.stream().pipe(i)}).fail(function(e){r.emit("error",e)}),r},d.prototype.createJob=function(e,t,o){return new p(this,e,t,o)},d.prototype.job=function(e){return new p(this,null,null,null,e)},a.on("connection:new",function(e){e.bulk=new d(e)}),t.exports=d}).call(this,e("_process"))},{_process:2}],2:[function(e,t,o){function n(){h=!1,a.length?c=a.concat(c):p=-1,c.length&&r()}function r(){if(!h){var e=setTimeout(n);h=!0;for(var t=c.length;t;){for(a=c,c=[];++p<t;)a&&a[p].run();p=-1,t=c.length}a=null,h=!1,clearTimeout(e)}}function i(e,t){this.fun=e,this.array=t}function s(){}var a,u=t.exports={},c=[],h=!1,p=-1;u.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var o=1;o<arguments.length;o++)t[o-1]=arguments[o];c.push(new i(e,t)),1!==c.length||h||setTimeout(r,0)},i.prototype.run=function(){this.fun.apply(null,this.array)},u.title="browser",u.browser=!0,u.env={},u.argv=[],u.version="",u.versions={},u.on=s,u.addListener=s,u.once=s,u.off=s,u.removeListener=s,u.removeAllListeners=s,u.emit=s,u.binding=function(e){throw new Error("process.binding is not supported")},u.cwd=function(){return"/"},u.chdir=function(e){throw new Error("process.chdir is not supported")},u.umask=function(){return 0}},{}]},{},[1])(1)});
//# sourceMappingURL=jsforce-api-bulk.min.js.map
